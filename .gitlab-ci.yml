# ============================================================================
# GitLab CI/CD Pipeline Optimis√© - SQLI Stage Project (FINAL)
# ============================================================================
# Backend: Spring Boot 3.5.3 (Java 17)
# Frontend: React Router 7 (Node.js 20)
# Features: Tests, Quality (SonarQube), Docker, Deploy
# ============================================================================

# ============================================================================
# VARIABLES GLOBALES
# ============================================================================
variables:
  # Maven
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "-B --no-transfer-progress"
  
  # Docker
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_BUILDKIT: 1
  
  # Images Docker (utilise GitLab Container Registry)
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend
  
  # SonarQube
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  SONAR_HOST_URL: "https://sonarcloud.io" # Forc√© ici pour √™tre s√ªr
  
  # Versions
  JAVA_VERSION: "17"
  NODE_VERSION: "20"
  MAVEN_VERSION: "3.9.6"

# ============================================================================
# CACHE OPTIMIS√â
# ============================================================================
cache:
  key:
    files:
      - backend-sqli/pom.xml
      - frontend-sqli/package-lock.json
    prefix: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository/
    - frontend-sqli/node_modules/
    - .sonar/cache/
  policy: pull-push

# ============================================================================
# STAGES DU PIPELINE
# ============================================================================
stages:
  - build
  - test
  - quality
  - security
  - docker-build
  - deploy
  - smoke-test

# ============================================================================
# TEMPLATES R√âUTILISABLES
# ============================================================================

# Template pour les jobs Maven
.maven_template: &maven_template
  image: maven:3.9.6-eclipse-temurin-17
  before_script:
    - cd backend-sqli
    - echo "Maven version:" && mvn --version

# Template pour les jobs Node.js
.node_template: &node_template
  image: node:20-alpine
  before_script:
    - cd frontend-sqli
    - echo "Node version:" && node --version
    - echo "NPM version:" && npm --version

# Template pour les jobs Docker
.docker_template: &docker_template
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

# Template pour les d√©ploiements
.deploy_template: &deploy_template
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | base64 -d | ssh-add - > /dev/null 2>&1
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null

# ============================================================================
# STAGE 1: BUILD
# ============================================================================

# Build Backend (Compile + Package)
backend:build:
  <<: *maven_template
  stage: build
  script:
    - echo "üî® Build du backend Spring Boot..."
    - mvn clean package -DskipTests $MAVEN_CLI_OPTS
    - echo "‚úÖ Build termin√©"
  artifacts:
    name: "backend-${CI_COMMIT_SHORT_SHA}"
    paths:
      - backend-sqli/target/*.jar
      - backend-sqli/target/classes/
    expire_in: 1 day
  rules:
    - changes:
        - backend-sqli/**/*
        - pom.xml
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Build Frontend
frontend:build:
  <<: *node_template
  stage: build
  script:
    - echo "üî® Build du frontend React..."
    - npm ci --prefer-offline --no-audit
    - npm run build
    - echo "‚úÖ Build termin√©"
    - ls -lh build/
  artifacts:
    name: "frontend-${CI_COMMIT_SHORT_SHA}"
    paths:
      - frontend-sqli/build/
    expire_in: 1 day
  rules:
    - changes:
        - frontend-sqli/**/*
        - package.json
        - package-lock.json
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ============================================================================
# STAGE 2: TESTS
# ============================================================================

# Tests Backend avec JUnit + Jacoco (couverture)
backend:test:
  <<: *maven_template
  stage: test
  needs:
    - backend:build
  script:
    - echo "üß™ Ex√©cution des tests backend..."
    - mvn test -B -Dspring.profiles.active=test
    - echo "üìä G√©n√©ration du rapport de couverture..."
    - mvn jacoco:report -B || true
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    when: always
    name: "backend-tests-${CI_COMMIT_SHORT_SHA}"
    paths:
      - backend-sqli/target/surefire-reports/
      - backend-sqli/target/site/jacoco/
    reports:
      junit: backend-sqli/target/surefire-reports/TEST-*.xml
    expire_in: 1 week
  rules:
    - changes:
        - backend-sqli/**/*
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Tests Frontend (Jest/Vitest)
frontend:test:
  <<: *node_template
  stage: test
  needs:
    - frontend:build
  script:
    - echo "üß™ Ex√©cution des tests frontend..."
    - npm ci --prefer-offline --no-audit
    - npm run test -- --coverage --watchAll=false --passWithNoTests || true
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    name: "frontend-tests-${CI_COMMIT_SHORT_SHA}"
    paths:
      - frontend-sqli/coverage/
    expire_in: 1 week
  rules:
    - changes:
        - frontend-sqli/**/*
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

# V√©rification TypeScript
frontend:typecheck:
  <<: *node_template
  stage: test
  needs:
    - frontend:build
  script:
    - echo "üîç V√©rification TypeScript..."
    - npm ci --prefer-offline --no-audit
    - npm run typecheck
  rules:
    - changes:
        - frontend-sqli/**/*
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false

# Linting Frontend (ESLint)
frontend:lint:
  <<: *node_template
  stage: test
  needs:
    - frontend:build
  script:
    - echo "üîç Linting du code frontend..."
    - npm ci --prefer-offline --no-audit
    - npm run lint || true
  rules:
    - changes:
        - frontend-sqli/**/*
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

# ============================================================================
# STAGE 3: QUALIT√â (SonarQube Unified) - VERSION CORRIG√âE (SYNTAXE)
# ============================================================================
sonarqube:full-project:
  stage: quality
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  needs:
    - backend:test
    - frontend:test
  variables:
    GIT_DEPTH: 0
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  cache:
    key: "sonar-cache"
    paths:
      - .sonar/cache
  script:
    - echo "üìä Analyse SonarQube globale du projet..."
    - echo "üîç V√©rification des variables..."
    - |
      if [ -z "$SONAR_TOKEN" ]; then
        echo "‚ùå ERREUR: La variable SONAR_TOKEN est manquante dans GitLab CI/CD Settings."
        exit 1
      fi

    # CORRECTION ICI : Utilisation de ">" pour supprimer les antislashs probl√©matiques
    - >
      sonar-scanner
      -Dsonar.organization=sqli-projects
      -Dsonar.projectKey=sqli-platform
      -Dsonar.projectName="SQLI Full Platform"
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.token=$SONAR_TOKEN
      -Dsonar.sources=backend-sqli/src/main/java,frontend-sqli/app
      -Dsonar.tests=backend-sqli/src/test/java,frontend-sqli/app
      -Dsonar.test.inclusions=**/*.test.ts,**/*.test.tsx,**/*Test.java
      -Dsonar.java.binaries=backend-sqli/target/classes
      -Dsonar.coverage.jacoco.xmlReportPaths=backend-sqli/target/site/jacoco/jacoco.xml
      -Dsonar.javascript.lcov.reportPaths=frontend-sqli/coverage/lcov.info
      -Dsonar.typescript.tsconfigPath=frontend-sqli/tsconfig.json
      -Dsonar.sourceEncoding=UTF-8
      -Dsonar.qualitygate.wait=true

  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false
# ============================================================================
# STAGE 4: S√âCURIT√â
# ============================================================================

# Analyse des d√©pendances (OWASP Dependency Check)
security:dependency-check:
  <<: *maven_template
  stage: security
  needs:
    - backend:build
  script:
    - echo "üîí Analyse de s√©curit√© des d√©pendances..."
    - mvn org.owasp:dependency-check-maven:check -B || true
  artifacts:
    when: always
    paths:
      - backend-sqli/target/dependency-check-report.html
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: true

# Scan de s√©curit√© des secrets (GitLeaks)
security:secrets-scan:
  stage: security
  image: 
    name: zricethezav/gitleaks:latest
    entrypoint: [""]
  script:
    - echo "üîç Scan des secrets expos√©s..."
    - gitleaks detect --source . --verbose --no-git
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

# ============================================================================
# STAGE 5: DOCKER BUILD
# ============================================================================

# Build image Docker Backend
docker:backend:
  <<: *docker_template
  stage: docker-build
  needs:
    - backend:build
    - backend:test
  script:
    - echo "üê≥ Build de l'image Docker backend..."
    - export VERSION=${CI_COMMIT_TAG:-$CI_COMMIT_SHORT_SHA}
    - echo "Version $VERSION"
    - cd backend-sqli
    - docker build --build-arg JAR_FILE=target/*.jar --tag $BACKEND_IMAGE:$VERSION --tag $BACKEND_IMAGE:$CI_COMMIT_REF_SLUG .
    - docker push $BACKEND_IMAGE:$VERSION
    - docker push $BACKEND_IMAGE:$CI_COMMIT_REF_SLUG
    - if [ "$CI_COMMIT_BRANCH" == "main" ]; then docker tag $BACKEND_IMAGE:$VERSION $BACKEND_IMAGE:latest && docker push $BACKEND_IMAGE:latest; fi
    - echo "‚úÖ Image backend publi√©e"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_TAG

# Build image Docker Frontend
docker:frontend:
  <<: *docker_template
  stage: docker-build
  needs:
    - frontend:build
    - frontend:test
  script:
    - echo "üê≥ Build de l'image Docker frontend..."
    - export VERSION=${CI_COMMIT_TAG:-$CI_COMMIT_SHORT_SHA}
    - echo "Version $VERSION"
    - cd frontend-sqli
    - docker build --tag $FRONTEND_IMAGE:$VERSION --tag $FRONTEND_IMAGE:$CI_COMMIT_REF_SLUG .
    - docker push $FRONTEND_IMAGE:$VERSION
    - docker push $FRONTEND_IMAGE:$CI_COMMIT_REF_SLUG
    - if [ "$CI_COMMIT_BRANCH" == "main" ]; then docker tag $FRONTEND_IMAGE:$VERSION $FRONTEND_IMAGE:latest && docker push $FRONTEND_IMAGE:latest; fi
    - echo "‚úÖ Image frontend publi√©e"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_TAG

# ============================================================================
# STAGE 6: D√âPLOIEMENT
# ============================================================================

# D√©ploiement Staging
deploy:staging:
  <<: *deploy_template
  stage: deploy
  needs:
    - docker:backend
    - docker:frontend
  variables:
    DEPLOY_HOST: $STAGING_HOST
    DEPLOY_USER: $STAGING_USER
  script:
    - echo "üöÄ D√©ploiement sur STAGING..."
    - export VERSION=$CI_COMMIT_SHORT_SHA
    - ssh $DEPLOY_USER@$DEPLOY_HOST "echo 'JWT_SECRET=$JWT_SECRET' > /opt/sqli-app/.env && echo 'POSTGRES_PASSWORD=$POSTGRES_PASSWORD' >> /opt/sqli-app/.env && echo 'BACKEND_IMAGE=$BACKEND_IMAGE:$VERSION' >> /opt/sqli-app/.env && echo 'FRONTEND_IMAGE=$FRONTEND_IMAGE:$VERSION' >> /opt/sqli-app/.env && echo 'ENVIRONMENT=staging' >> /opt/sqli-app/.env"
    - scp docker-compose.yml $DEPLOY_USER@$DEPLOY_HOST:/opt/sqli-app/
    - ssh $DEPLOY_USER@$DEPLOY_HOST "cd /opt/sqli-app && docker-compose pull backend frontend && docker-compose up -d"
    - echo "‚è≥ Attente du d√©marrage des services..."
    - sleep 15
    - echo "‚úÖ D√©ploiement staging termin√©"
  environment:
    name: staging
    url: https://staging.sqli-app.com
    on_stop: stop:staging
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      when: manual
  allow_failure: false

# D√©ploiement Production
deploy:production:
  <<: *deploy_template
  stage: deploy
  needs:
    - docker:backend
    - docker:frontend
  variables:
    DEPLOY_HOST: $PROD_HOST
    DEPLOY_USER: $PROD_USER
  script:
    - echo "üöÄ D√©ploiement sur PRODUCTION..."
    - export VERSION=${CI_COMMIT_TAG:-$CI_COMMIT_SHORT_SHA}
    - ssh $DEPLOY_USER@$DEPLOY_HOST "echo 'JWT_SECRET=$JWT_SECRET_PROD' > /opt/sqli-app/.env && echo 'POSTGRES_PASSWORD=$POSTGRES_PASSWORD_PROD' >> /opt/sqli-app/.env && echo 'BACKEND_IMAGE=$BACKEND_IMAGE:$VERSION' >> /opt/sqli-app/.env && echo 'FRONTEND_IMAGE=$FRONTEND_IMAGE:$VERSION' >> /opt/sqli-app/.env && echo 'ENVIRONMENT=production' >> /opt/sqli-app/.env"
    - scp docker-compose.yml $DEPLOY_USER@$DEPLOY_HOST:/opt/sqli-app/
    - ssh $DEPLOY_USER@$DEPLOY_HOST "cd /opt/sqli-app && docker-compose exec -T postgres pg_dump -U postgres sqli_db > backup_$(date +%Y%m%d_%H%M%S).sql || true"
    - ssh $DEPLOY_USER@$DEPLOY_HOST "cd /opt/sqli-app && docker-compose pull backend frontend && docker-compose up -d"
    - echo "‚è≥ Attente du d√©marrage des services..."
    - sleep 20
    - echo "‚úÖ D√©ploiement production termin√©"
  environment:
    name: production
    url: https://sqli-app.com
    on_stop: stop:production
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
    - if: $CI_COMMIT_TAG
      when: manual
  allow_failure: false

# Arr√™t de l'environnement staging
stop:staging:
  <<: *deploy_template
  stage: deploy
  variables:
    DEPLOY_HOST: $STAGING_HOST
    DEPLOY_USER: $STAGING_USER
    GIT_STRATEGY: none
  script:
    - echo "üõë Arr√™t de l'environnement staging..."
    - ssh $DEPLOY_USER@$DEPLOY_HOST "cd /opt/sqli-app && docker-compose down"
  environment:
    name: staging
    action: stop
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      when: manual

# Arr√™t de l'environnement production
stop:production:
  <<: *deploy_template
  stage: deploy
  variables:
    DEPLOY_HOST: $PROD_HOST
    DEPLOY_USER: $PROD_USER
    GIT_STRATEGY: none
  script:
    - echo "üõë Arr√™t de l'environnement production..."
    - ssh $DEPLOY_USER@$DEPLOY_HOST "cd /opt/sqli-app && docker-compose down"
  environment:
    name: production
    action: stop
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual

# ============================================================================
# STAGE 7: SMOKE TESTS POST-D√âPLOIEMENT
# ============================================================================

# Tests de fum√©e Staging
smoke:staging:
  stage: smoke-test
  image: curlimages/curl:latest
  needs:
    - deploy:staging
  script:
    - echo "üß™ Tests de fum√©e sur staging..."
    - sleep 10
    - echo "V√©rification du backend..."
    - curl -f -m 10 https://staging.sqli-app.com/actuator/health || exit 1
    - echo "V√©rification du frontend..."
    - curl -f -m 10 https://staging.sqli-app.com || exit 1
    - echo "‚úÖ Tous les tests de fum√©e passent"
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  allow_failure: false
  retry: 2

# Tests de fum√©e Production
smoke:production:
  stage: smoke-test
  image: curlimages/curl:latest
  needs:
    - deploy:production
  script:
    - echo "üß™ Tests de fum√©e sur production..."
    - sleep 15
    - echo "V√©rification du backend..."
    - curl -f -m 10 https://sqli-app.com/actuator/health || exit 1
    - echo "V√©rification du frontend..."
    - curl -f -m 10 https://sqli-app.com || exit 1
    - echo "‚úÖ Tous les tests de fum√©e passent"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
  allow_failure: false
  retry: 2

# ============================================================================
# JOBS SP√âCIAUX
# ============================================================================

# Nettoyage des anciennes images Docker
cleanup:docker:
  stage: .post
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - echo "üßπ Nettoyage des images Docker obsol√®tes..."
    - docker system prune -af --filter "until=168h"
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: true