# GitLab CI/CD Pipeline pour SQLI Stage Project
# Backend: Spring Boot 3.5.3 (Java 17)
# Frontend: React Router 7 (Node.js 20)

# Variables globales
variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "-B -DskipTests"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  # Images Docker (à personnaliser avec votre registry)
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend

# Cache pour accélérer les builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository/
    - frontend-sqli/node_modules/

# Stages du pipeline
stages:
  - build
  - test
  - quality
  - docker-build
  - deploy

# ==========================================
# BACKEND JOBS
# ==========================================

# Build du backend
backend:build:
  stage: build
  image: maven:3.9.6-eclipse-temurin-17
  script:
    - cd backend-sqli
    - mvn clean compile $MAVEN_CLI_OPTS
  artifacts:
    paths:
      - backend-sqli/target/
    expire_in: 1 hour
  rules:
    - changes:
        - backend-sqli/**/*

# Tests du backend
backend:test:
  stage: test
  image: maven:3.9.6-eclipse-temurin-17
  services:
    - name: postgres:15-alpine
      alias: postgres
  variables:
    POSTGRES_DB: sqli_db_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/sqli_db_test
    SPRING_DATASOURCE_USERNAME: postgres
    SPRING_DATASOURCE_PASSWORD: postgres
  script:
    - cd backend-sqli
    - mvn test -B
  artifacts:
    when: always
    paths:
      - backend-sqli/target/surefire-reports/
    reports:
      junit: backend-sqli/target/surefire-reports/TEST-*.xml
    expire_in: 1 week
  rules:
    - changes:
        - backend-sqli/**/*
  needs:
    - backend:build

# Package du backend (créer le JAR)
backend:package:
  stage: build
  image: maven:3.9.6-eclipse-temurin-17
  script:
    - cd backend-sqli
    - mvn clean package -DskipTests -B
  artifacts:
    paths:
      - backend-sqli/target/*.jar
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ==========================================
# FRONTEND JOBS
# ==========================================

# Build du frontend
frontend:build:
  stage: build
  image: node:20-alpine
  script:
    - cd frontend-sqli
    - npm ci
    - npm run build
  artifacts:
    paths:
      - frontend-sqli/build/
    expire_in: 1 hour
  rules:
    - changes:
        - frontend-sqli/**/*

# Vérification TypeScript
frontend:typecheck:
  stage: test
  image: node:20-alpine
  script:
    - cd frontend-sqli
    - npm ci
    - npm run typecheck
  rules:
    - changes:
        - frontend-sqli/**/*
  needs:
    - frontend:build
  allow_failure: true

# ==========================================
# QUALITÉ DU CODE
# ==========================================

# Analyse SonarQube (optionnel - décommenter si SonarQube est configuré)
# sonarqube:
#   stage: quality
#   image: sonarsource/sonar-scanner-cli:latest
#   variables:
#     SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
#     GIT_DEPTH: "0"
#   cache:
#     key: "${CI_JOB_NAME}"
#     paths:
#       - .sonar/cache
#   script:
#     - sonar-scanner
#   rules:
#     - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"
#   allow_failure: true

# Vérification des dépendances (sécurité)
dependency-check:
  stage: quality
  image: maven:3.9.6-eclipse-temurin-17
  script:
    - cd backend-sqli
    - mvn dependency:analyze -B || true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true

# ==========================================
# DOCKER BUILD
# ==========================================

# Build image Docker backend
docker:backend:
  stage: docker-build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $BACKEND_IMAGE:$CI_COMMIT_SHA -t $BACKEND_IMAGE:latest ./backend-sqli
    - docker push $BACKEND_IMAGE:$CI_COMMIT_SHA
    - docker push $BACKEND_IMAGE:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"
  needs:
    - backend:package
    - backend:test

# Build image Docker frontend
docker:frontend:
  stage: docker-build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $FRONTEND_IMAGE:$CI_COMMIT_SHA -t $FRONTEND_IMAGE:latest ./frontend-sqli
    - docker push $FRONTEND_IMAGE:$CI_COMMIT_SHA
    - docker push $FRONTEND_IMAGE:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"
  needs:
    - frontend:build

# ==========================================
# DÉPLOIEMENT
# ==========================================

# Déploiement sur environnement de staging
deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
  script:
    - echo "Déploiement sur le serveur staging..."
    - ssh $STAGING_USER@$STAGING_HOST "cd /opt/sqli-app && docker-compose pull && docker-compose up -d"
  environment:
    name: staging
    url: https://staging.sqli-app.com
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  when: manual
  needs:
    - docker:backend
    - docker:frontend

# Déploiement sur environnement de production
deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
  script:
    - echo "Déploiement sur le serveur de production..."
    - ssh $PROD_USER@$PROD_HOST "cd /opt/sqli-app && docker-compose pull && docker-compose up -d"
  environment:
    name: production
    url: https://sqli-app.com
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  when: manual
  needs:
    - docker:backend
    - docker:frontend
